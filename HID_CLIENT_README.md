# ESP32 HID Client для пульта BT13

## Проблема и решение

### Исходная проблема
Оригинальный код работал как Bluetooth-сервер (ESP32 ожидал подключения), но пульт BT13 работает как HID-устройство и не может подключаться к серверам.

### Анализ пульта BT13
Из анализа Ubuntu выяснилось:
- **Протокол**: HID (Human Interface Device)
- **Кнопки**: 
  - `KEY_VOLUMEUP` (0xE9) - увеличение громкости
  - `KEY_VOLUMEDOWN` (0xEA) - уменьшение громкости
  - `KEY_PLAYPAUSE` (0xCD) - воспроизведение/пауза
- **MAC**: 8B:EB:75:4E:65:97
- **Производитель**: Zhuhai Jieli technology Co.,Ltd

### Решение
Создано два варианта:
1. **ESP-IDF версия** (рекомендуется) - полная поддержка HID Host
2. **Arduino IDE версия** (упрощенная) - ограниченная функциональность

## Вариант 1: ESP-IDF (Рекомендуется)

### Преимущества
✅ Полная поддержка HID Host протокола  
✅ Автоматическое подключение к BT13  
✅ Правильная обработка HID событий  
✅ Стабильная работа  
✅ Автоматическое переподключение  

### Установка ESP-IDF

```bash
# 1. Установка зависимостей (Ubuntu)
sudo apt-get install git wget flex bison gperf python3 python3-pip python3-setuptools cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0

# 2. Клонирование ESP-IDF
cd ~/
git clone --recursive https://github.com/espressif/esp-idf.git
cd esp-idf
git checkout v5.1.2

# 3. Установка инструментов
./install.sh esp32

# 4. Настройка окружения
. ./export.sh
```

### Сборка и прошивка

```bash
# 1. Переход в папку проекта
cd /path/to/bluetooth2brushless/esp-idf-version

# 2. Настройка проекта
idf.py set-target esp32
idf.py menuconfig

# 3. Сборка
idf.py build

# 4. Прошивка (замените /dev/ttyUSB0 на ваш порт)
idf.py -p /dev/ttyUSB0 flash

# 5. Мониторинг
idf.py -p /dev/ttyUSB0 monitor
```

### Настройки в menuconfig
```
Component config → Bluetooth → 
  [*] Bluetooth
  [*] Classic Bluetooth
  [*] HID Host
  [ ] BLE (отключить для экономии памяти)
```

## Вариант 2: Arduino IDE (Упрощенный)

### Ограничения
⚠️ Ограниченная поддержка HID Host в Arduino  
⚠️ Может потребоваться ручная настройка  
⚠️ Менее стабильная работа  

### Установка

1. **Arduino IDE**: Версия 2.0 или выше
2. **ESP32 пакет**: Версия 2.0.0 или выше
3. **Библиотеки**: ESP32-BLE-Arduino

### Настройка Arduino IDE

```
Файл → Настройки → Дополнительные ссылки для Менеджера плат:
https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json

Инструменты → Плата → Менеджер плат → ESP32 → Установить

Инструменты → Плата → ESP32 Arduino → ESP32 Dev Module
```

### Загрузка кода

1. Откройте `bluetooth2brushless_hid_client.ino`
2. Выберите правильный порт
3. Нажмите "Загрузить"

## Схема подключения

Подключение остается таким же:

```
ESP32 GPIO 25 → Контроллер SPEED (PWM)
ESP32 GPIO 26 → Контроллер DIRECTION
ESP32 GND     → Контроллер GND
ESP32 GPIO 2  → LED индикатор
```

## Принцип работы

### 1. Инициализация
- ESP32 запускается как HID Host
- Начинается поиск устройств Bluetooth

### 2. Поиск BT13
- Сканирование устройств по MAC адресу
- Автоматическое подключение при обнаружении

### 3. Обработка команд
- `Volume Up` → Увеличение скорости двигателя
- `Volume Down` → Уменьшение скорости двигателя  
- `Play/Pause` → Изменение направления вращения

### 4. Безопасность
- Автоматическая остановка при отключении пульта
- Автоматическое переподключение
- LED индикация состояния

## Отладка

### ESP-IDF мониторинг
```bash
idf.py monitor
```

### Arduino IDE мониторинг
```
Инструменты → Монитор порта → 115200 baud
```

### Типичные сообщения
```
I (1234) BT13_MOTOR_CONTROL: Поиск пульта BT13...
I (2345) BT13_MOTOR_CONTROL: Найден BT13! Подключение...
I (3456) BT13_MOTOR_CONTROL: BT13 подключен успешно!
I (4567) BT13_MOTOR_CONTROL: Нажата кнопка: 0xE9
I (4568) BT13_MOTOR_CONTROL: Команда: Увеличить скорость
I (4569) BT13_MOTOR_CONTROL: Скорость: 25/255, Состояние: ВКЛ
```

## Устранение неполадок

### BT13 не найден
1. Проверьте, что BT13 включен и в режиме сопряжения
2. Убедитесь, что MAC адрес правильный
3. Отключите BT13 от других устройств

### Не подключается
1. Очистите список сопряженных устройств на BT13
2. Перезагрузите ESP32
3. Проверьте логи на наличие ошибок

### Команды не работают
1. Проверьте подключение двигателя
2. Убедитесь, что HID события получаются
3. Проверьте коды кнопок в логах

## Модификации

### Изменение MAC адреса BT13
```c
// В main.c или .ino файле
static esp_bd_addr_t bt13_addr = {0x8B, 0xEB, 0x75, 0x4E, 0x65, 0x97};
```

### Изменение скорости
```c
static const int speed_step = 25;   // Шаг изменения скорости
static const int max_speed = 255;   // Максимальная скорость
```

### Добавление новых команд
```c
case 0xB5: // Next Song
    ESP_LOGI(TAG, "Команда: Следующий режим");
    // Ваш код
    break;
```

## Сравнение версий

| Функция | ESP-IDF | Arduino IDE |
|---------|---------|-------------|
| HID Host поддержка | ✅ Полная | ⚠️ Ограниченная |
| Автоподключение | ✅ Да | ⚠️ Частично |
| Стабильность | ✅ Высокая | ⚠️ Средняя |
| Сложность настройки | ⚠️ Высокая | ✅ Низкая |
| Размер кода | ⚠️ Больше | ✅ Меньше |
| Отладка | ✅ Подробная | ✅ Простая |

## Рекомендации

1. **Для продакшена**: Используйте ESP-IDF версию
2. **Для прототипа**: Arduino IDE версия подойдет
3. **Для изучения**: Начните с Arduino IDE, затем переходите на ESP-IDF

## Поддержка

При возникновении проблем:
1. Проверьте логи
2. Убедитесь в правильности подключения
3. Проверьте совместимость версий
4. Создайте Issue в репозитории с подробным описанием