# Диагностика проблем

## Проблема: Скрипт не прошивает ESP32

### Симптомы
- Скрипт `install.sh` завершается с ошибкой прошивки
- При ручной прошивке `idf.py -p /dev/ttyUSB0 flash` работает нормально

### Возможные причины и решения

#### 1. Проблемы с правами доступа
```bash
# Проверить права на порт
ls -la /dev/ttyUSB0

# Добавить пользователя в группу dialout
sudo usermod -a -G dialout $USER

# Перелогиниться или выполнить
newgrp dialout
```

#### 2. Порт занят другим процессом
```bash
# Проверить, что использует порт
sudo lsof /dev/ttyUSB0

# Завершить процессы, использующие порт
sudo pkill -f ttyUSB0
```

#### 3. Неправильное определение порта в скрипте
```bash
# Проверить доступные порты
ls /dev/tty*

# Запустить скрипт с указанием порта вручную
# Отредактировать скрипт или использовать ручную прошивку
```

#### 4. ESP-IDF окружение не активировано в скрипте
```bash
# Убедиться, что ESP-IDF активирован
echo $IDF_PATH

# Если не активирован, выполнить
source ~/esp/esp-idf/export.sh

# Затем запустить скрипт
```

### Обходное решение
Если скрипт не работает, используйте ручную прошивку:

```bash
cd bluetooth2brushless/esp-idf-version
source ~/esp/esp-idf/export.sh  # активировать ESP-IDF
idf.py build                    # собрать проект
idf.py -p /dev/ttyUSB0 flash monitor  # прошить и запустить мониторинг
```

## Проблема: Не выводятся данные о состоянии мотора

### Симптомы
- HID данные получаются: `04 00`, `08 00`, `10 00`, `01 00`, `02 00`
- Но не выводятся сообщения: "Команда: ...", "Работает вперед на X%"

### Решение
Эта проблема исправлена в последней версии кода. Обновите код:

```bash
cd bluetooth2brushless
git pull origin main
cd esp-idf-version
idf.py build
idf.py -p /dev/ttyUSB0 flash
```

### Ожидаемый вывод после исправления
```
I (68630) BT13_MOTOR_CONTROL: HID данные (2 байт):
04 00 
I (68630) BT13_MOTOR_CONTROL: HID Usage: 0x0004
I (68630) BT13_MOTOR_CONTROL: Команда: Короткое + (увеличение уровня)
I (68630) BT13_MOTOR_CONTROL: Работает вперед на 10%
```

## Соответствие HID кодов командам

На основе реальных логов (ИСПРАВЛЕНО):

| HID код | Команда | Действие |
|---------|---------|----------|
| `04 00` | 0x0004 | Короткое + (увеличение на 1 уровень) |
| `08 00` | 0x0008 | Короткое - (уменьшение на 1 уровень) |
| `10 00` | 0x0010 | Средняя кнопка (полная остановка) |
| `01 00` | 0x0001 | Короткое - (уменьшение на 1 уровень) |
| `02 00` | 0x0002 | Длинное - (максимум назад) |

## Проверка работы системы

### 1. Проверить подключение BT13
```
I (62470) BT13_MOTOR_CONTROL: BT13 подключен успешно!
I (62470) BT13_MOTOR_CONTROL: Готов к приему команд от пульта
```

### 2. Проверить получение HID данных
```
I (68630) BT13_MOTOR_CONTROL: HID данные (2 байт):
04 00 
```

### 3. Проверить обработку команд
```
I (68630) BT13_MOTOR_CONTROL: HID Usage: 0x0004
I (68630) BT13_MOTOR_CONTROL: Команда: Короткое + (увеличение уровня)
I (68630) BT13_MOTOR_CONTROL: Работает вперед на 10%
```

## Дополнительная диагностика

### Проверить версию прошивки
В логах должно быть:
```
I (365) app_init: App version:      b848328  # или более новая версия
```

### Проверить GPIO подключения
- ESP32 GPIO 25 → ESC PWM вход
- ESP32 GPIO 26 → ESC реверс  
- ESP32 GND → ESC GND

### Если проблемы продолжаются
1. Очистить и пересобрать проект:
   ```bash
   idf.py fullclean
   idf.py build
   ```

2. Проверить кабель USB и порт

3. Попробовать другой ESP32

4. Создать issue в репозитории с полными логами