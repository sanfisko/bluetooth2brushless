# üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ BT13 –ø—É–ª—å—Ç–∞

## üìã –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è BT13 –ø—É–ª—å—Ç–∞ (–≤—ã–∫–ª—é—á–µ–Ω–∏–µ/–≤–∫–ª—é—á–µ–Ω–∏–µ) ESP32 –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–ª –ø–æ–∏—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —Ç—Ä–µ–±–æ–≤–∞–ª–∞—Å—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ ESP32.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ
–î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.

## üîß –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –ó–∞–¥–∞—á–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
```c
static void connection_monitor_task(void *pvParameters)
{
    // –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 500–º—Å
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–∏—Å–∫ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
}
```

### 2. –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π callback
**–ë—ã–ª–æ:**
```c
case 1: // CLOSE_EVENT  
    bt13_connected = false;
    ESP_LOGI(TAG, "BT13 –æ—Ç–∫–ª—é—á–µ–Ω. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞...");
    motor_stop();
    vTaskDelay(pdMS_TO_TICKS(2000)); // ‚ùå –ë–ª–æ–∫–∏—Ä—É–µ—Ç callback
    start_scan_for_bt13();
    break;
```

**–°—Ç–∞–ª–æ:**
```c
case 1: // CLOSE_EVENT  
    bt13_connected = false;
    ESP_LOGI(TAG, "BT13 –æ—Ç–∫–ª—é—á–µ–Ω. –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞...");
    motor_stop();
    led_blink(5, 100); // –ò–Ω–¥–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
    restart_scan_needed = true; // ‚úÖ –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π —Ñ–ª–∞–≥
    break;
```

### 3. –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∏—Å–∫–∞
```c
static void start_scan_for_bt13(void)
{
    if (scanning_in_progress) {
        ESP_LOGI(TAG, "–ü–æ–∏—Å–∫ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...");
        return;
    }
    
    if (bt13_connected) {
        ESP_LOGI(TAG, "BT13 —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω, –ø–æ–∏—Å–∫ –Ω–µ –Ω—É–∂–µ–Ω");
        return;
    }
    
    // –ó–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞...
}
```

### 4. –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–∏—Å–∫–∞
```c
case ESP_BT_GAP_DISC_STATE_CHANGED_EVT:
    if (param->disc_st_chg.state == ESP_BT_GAP_DISCOVERY_STOPPED) {
        ESP_LOGI(TAG, "–ü–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∑–∞–≤–µ—Ä—à–µ–Ω");
        scanning_in_progress = false;
    } else if (param->disc_st_chg.state == ESP_BT_GAP_DISCOVERY_STARTED) {
        ESP_LOGI(TAG, "–ü–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –Ω–∞—á–∞—Ç");
        scanning_in_progress = true;
    }
    break;
```

## üéØ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ü—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –ø—É–ª—å—Ç–∞:
1. **Callback –ø–æ–ª—É—á–∞–µ—Ç CLOSE_EVENT**
2. **–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ñ–ª–∞–≥ `restart_scan_needed = true`**
3. **–î–≤–∏–≥–∞—Ç–µ–ª—å –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è**
4. **LED –º–∏–≥–∞–µ—Ç 5 —Ä–∞–∑ (–∏–Ω–¥–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è)**

### –ó–∞–¥–∞—á–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
1. **–ö–∞–∂–¥—ã–µ 500–º—Å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–ª–∞–≥ `restart_scan_needed`**
2. **–ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–º —Ñ–ª–∞–≥–µ –∂–¥–µ—Ç 3 —Å–µ–∫—É–Ω–¥—ã**
3. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –ø—É–ª—å—Ç –≤—Å–µ –µ—â–µ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω**
4. **–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–∏—Å–∫ BT13**

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞:
- **–ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è**
- **–ï—Å–ª–∏ –¥–æ–ª–≥–æ –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–∏—Å–∫**
- **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∏—Å–∫–∞**

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏

### –ü—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –ø—É–ª—å—Ç–∞:
```
I (xxx) BT13_MOTOR_CONTROL: BT13 –æ—Ç–∫–ª—é—á–µ–Ω. –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞...
I (xxx) BT13_MOTOR_CONTROL: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞ BT13 —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã...
I (xxx) BT13_MOTOR_CONTROL: –ó–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞ BT13...
I (xxx) BT13_MOTOR_CONTROL: –ü–æ–∏—Å–∫ –ø—É–ª—å—Ç–∞ BT13 (MAC: 8B:EB:75:4E:65:97)...
I (xxx) BT13_MOTOR_CONTROL: –ü–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –Ω–∞—á–∞—Ç
```

### –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤–∫–ª—é—á–µ–Ω–∏–∏ –ø—É–ª—å—Ç–∞:
```
I (xxx) BT13_MOTOR_CONTROL: –ù–∞–π–¥–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: 8b:eb:75:4e:65:97
I (xxx) BT13_MOTOR_CONTROL: –ù–∞–π–¥–µ–Ω BT13! –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∏—Å–∫...
I (xxx) BT13_MOTOR_CONTROL: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ BT13...
I (xxx) BT13_MOTOR_CONTROL: BT13 –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ!
I (xxx) BT13_MOTOR_CONTROL: –ì–æ—Ç–æ–≤ –∫ –ø—Ä–∏–µ–º—É –∫–æ–º–∞–Ω–¥ –æ—Ç –ø—É–ª—å—Ç–∞
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### –¢–∞–π–º–∞—É—Ç—ã (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ –∫–æ–¥–µ):
- **–ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º:** 3 —Å–µ–∫—É–Ω–¥—ã
- **–ß–∞—Å—Ç–æ—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:** 500–º—Å  
- **–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:** 30 —Å–µ–∫—É–Ω–¥
- **–í—Ä–µ–º—è –ø–æ–∏—Å–∫–∞:** 10 —Å–µ–∫—É–Ω–¥

### –ò–Ω–¥–∏–∫–∞—Ü–∏—è:
- **–ü—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏:** 5 –±—ã—Å—Ç—Ä—ã—Ö –º–∏–≥–∞–Ω–∏–π LED
- **–ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏:** 3 –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –º–∏–≥–∞–Ω–∏—è LED
- **–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:** 1 –∫–æ—Ä–æ—Ç–∫–æ–µ –º–∏–≥–∞–Ω–∏–µ LED

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** - –Ω–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å ESP32
2. **‚ö° –ë—ã—Å—Ç—Ä–∞—è —Ä–µ–∞–∫—Ü–∏—è** - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
3. **üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è** - –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
4. **üîç –£–º–Ω—ã–π –ø–æ–∏—Å–∫** - –∏–∑–±–µ–≥–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ª–∏—à–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
5. **üìä –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏** - –ª–µ–≥–∫–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ

## üéÆ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. **–í–∫–ª—é—á–∏—Ç–µ ESP32 –∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ BT13**
2. **–í—ã–∫–ª—é—á–∏—Ç–µ –ø—É–ª—å—Ç BT13**
3. **–ù–∞–±–ª—é–¥–∞–π—Ç–µ –ª–æ–≥–∏ - –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫**
4. **–í–∫–ª—é—á–∏—Ç–µ –ø—É–ª—å—Ç BT13 –æ–±—Ä–∞—Ç–Ω–æ**
5. **–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏**

---
*–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –¥–ª—è ESP-IDF v5.4.1*  
*–î–∞—Ç–∞: 2025-06-09*