# 📡 install_bt.sh - Установщик с Bluetooth сканированием

Расширенная версия установщика с автоматическим поиском и настройкой Bluetooth устройств.

## 🚀 Быстрый старт

```bash
# Запуск установщика с Bluetooth сканированием
./install_bt.sh
```

## 🔍 Возможности

### ✅ Все функции оригинального install.sh:
- Автоматическая установка ESP-IDF
- Компиляция проекта
- Прошивка ESP32
- Мониторинг работы

### 🆕 Дополнительные возможности:
- **🔍 Bluetooth сканирование** - автоматический поиск устройств в округе
- **📋 Список устройств** - показывает все найденные BT устройства с именами и MAC
- **⚙️ Автоматическая настройка** - обновляет MAC адрес в коде проекта
- **💾 Резервное копирование** - создает backup файла main.c перед изменениями

## 📡 Процесс работы

1. **Проверка ESP-IDF** - как в оригинальном скрипте
2. **🔍 Сканирование Bluetooth**:
   - Проверка наличия bluetooth инструментов
   - Включение Bluetooth адаптера
   - 15-секундное сканирование устройств
   - Отображение списка найденных устройств
3. **⚙️ Выбор устройства**:
   - Интерактивный выбор из списка
   - Автоматическое обновление MAC в коде
   - Создание резервной копии
4. **🔨 Компиляция и прошивка** - как в оригинальном скрипте

## 🛠️ Требования

### Системные пакеты:
```bash
# Ubuntu/Debian
sudo apt install bluetooth bluez-tools

# CentOS/RHEL/Fedora
sudo yum install bluez bluez-tools

# macOS
brew install blueutil
```

### Поддерживаемые инструменты:
- **blueutil** (macOS, основной)
- **bluetoothctl** (Linux, основной)
- **hcitool** (резервный)
- **rfkill** (Linux, для управления питанием)

## 🆘 Если сканирование не работает

Скрипт автоматически предложит **ручной ввод MAC адреса** в следующих случаях:
- Bluetooth инструменты недоступны
- Не удалось включить Bluetooth
- Сканирование не нашло устройства

### Как найти MAC адрес BT13:
1. **На телефоне/компьютере**: Настройки → Bluetooth → найти "BT13"
2. **В настройках BT13**: некоторые модели показывают MAC на экране
3. **Через другие BT сканеры**: любое приложение для сканирования Bluetooth

## 📋 Пример работы

```
╔══════════════════════════════════════════════════════════════╗
║         ESP32 Bluetooth Motor Control Setup (BT)            ║
║       github.com/sanfisko/esp32-bluetooth-motor-control     ║
╚══════════════════════════════════════════════════════════════╝

📡 Настройка Bluetooth устройства

🔍 Проверка Bluetooth инструментов...
✅ bluetoothctl найден
✅ rfkill найден

📡 Проверка состояния Bluetooth...
✅ Bluetooth готов к сканированию

🔍 Сканирование Bluetooth устройств...
Включите ваш BT13 пульт (долгое нажатие средней кнопки)
Сканирование займет 15 секунд...

✅ Найденные Bluetooth устройства:

1) BT13 (8B:EB:75:4E:65:97)
2) iPhone (AA:BB:CC:DD:EE:FF)
3) Headphones (11:22:33:44:55:66)

0) Пропустить и использовать MAC по умолчанию

Выберите устройство (0-3): 1
✅ Выбрано: BT13 (8B:EB:75:4E:65:97)

🔧 Обновление MAC адреса в коде...
✅ MAC адрес обновлен в коде: {0x8B, 0xEB, 0x75, 0x4E, 0x65, 0x97}
💾 Создана резервная копия: main/main.c.backup

🎉 Bluetooth устройство настроено успешно!
```

### Пример с ручным вводом MAC:
```
⚠️  Сканирование не дало результатов
Убедитесь что:
1. BT13 включен (синий LED мигает)
2. BT13 находится рядом (< 10 метров)
3. BT13 не подключен к другому устройству

💡 Попробуйте:
• Перезапустить BT13 (выключить/включить)
• Отключить BT13 от других устройств
• Запустить скрипт с sudo (если требуется)

💡 Хотите ввести MAC адрес вручную?
Ввести MAC вручную? (y/N): y

✏️  Ручной ввод MAC адреса
Введите MAC адрес вашего BT13 пульта в формате XX:XX:XX:XX:XX:XX
Пример: 8B:EB:75:4E:65:97

MAC адрес: 8B:EB:75:4E:65:97
✅ MAC адрес корректен: 8B:EB:75:4E:65:97

🔧 Обновление MAC адреса в коде...
✅ MAC адрес обновлен в коде: {0x8B, 0xEB, 0x75, 0x4E, 0x65, 0x97}
💾 Создана резервная копия: main/main.c.backup

🎉 MAC адрес настроен вручную!
```

## 🔧 Технические детали

### Формат MAC адреса:
- **Вход**: `8B:EB:75:4E:65:97`
- **В коде**: `{0x8B, 0xEB, 0x75, 0x4E, 0x65, 0x97}`

### Файлы изменений:
- **Основной файл**: `main/main.c` (строка 44)
- **Резервная копия**: `main/main.c.backup`
- **Временные файлы**: `/tmp/bt_devices.txt`, `/tmp/selected_mac.txt`

### Алгоритм сканирования:
1. **bluetoothctl scan on** (15 секунд)
2. **bluetoothctl devices** (получение списка)
3. **hcitool scan** (резервный метод)

## ⚠️ Важные моменты

1. **Включите BT13** перед сканированием (долгое нажатие средней кнопки)
2. **Синий LED должен мигать** на BT13
3. **Расстояние < 10 метров** для надежного обнаружения
4. **Отключите от других устройств** если BT13 уже подключен
5. **Права sudo** могут потребоваться для управления Bluetooth

## 🔄 Восстановление

Если что-то пошло не так:

```bash
# Восстановить оригинальный main.c
cp main/main.c.backup main/main.c

# Или использовать оригинальный установщик
./install.sh
```

## 🆚 Отличия от install.sh

| Функция | install.sh | install_bt.sh |
|---------|------------|---------------|
| ESP-IDF установка | ✅ | ✅ |
| Компиляция | ✅ | ✅ |
| Прошивка | ✅ | ✅ |
| Мониторинг | ✅ | ✅ |
| **BT сканирование** | ❌ | ✅ |
| **Автонастройка MAC** | ❌ | ✅ |
| **Список устройств** | ❌ | ✅ |
| **Резервные копии** | ❌ | ✅ |

---

**Рекомендация**: Используйте `install_bt.sh` если у вас несколько BT устройств или неизвестен MAC адрес вашего пульта.